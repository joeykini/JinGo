name: Build All Platforms

on:
  workflow_dispatch:
    inputs:
      brand_id:
        description: "Brand ID (white-labeling folder number)"
        required: true
        default: "1"
        type: choice
        options:
          - "1"
          - "2"
          - "3"
          - "4"
          - "5"
      build_type:
        description: "Build Type"
        required: true
        default: "Release"
        type: choice
        options:
          - "Debug"
          - "Release"
      platforms:
        description: "Platforms to build"
        required: true
        default: "all"
        type: choice
        options:
          - "all"
          - "macos"
          - "windows"
          - "linux"
          - "android"
          - "ios"

env:
  # Qt 版本配置
  # 项目要求: Qt 6.5+ (见 cmake/Dependencies-Qt.cmake)
  # 查看 aqtinstall 可用版本: https://ddalcino.github.io/aqt-list-server/
  # 或运行: aqt list-qt linux desktop
  QT_VERSION: "6.8.1" # LTS 版本，支持到 2029-10
  ANDROID_NDK_VERSION: "27.2.12479018"
  ANDROID_BUILD_TOOLS_VERSION: "34.0.0"
  ANDROID_PLATFORM: "android-34"

jobs:
  # ============================================================================
  # macOS Build
  # ============================================================================
  build-macos:
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'macos' }}
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt
        id: install-qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: "mac"
          target: "desktop"
          arch: "clang_64"
          cache: true

      - name: Debug Qt Environment
        run: |
          echo "Qt6_DIR: $Qt6_DIR"
          echo "QT_ROOT_DIR: $QT_ROOT_DIR"
          env | grep -E "Qt|QT" || true

      - name: Apply White Label Config
        run: |
          cp white-labeling/${{ github.event.inputs.brand_id }}/bundle_config.json resources/bundle_config.json
          if [ -d "white-labeling/${{ github.event.inputs.brand_id }}/icons" ]; then
            cp -r white-labeling/${{ github.event.inputs.brand_id }}/icons/* resources/icons/ 2>/dev/null || true
          fi

      - name: Build macOS
        run: |
          chmod +x scripts/build/build-macos.sh
          # 脚本会自动使用 Qt6_DIR 环境变量
          if [ "${{ github.event.inputs.build_type }}" = "Release" ]; then
            ./scripts/build/build-macos.sh --release --skip-sign
          else
            ./scripts/build/build-macos.sh --skip-sign
          fi

      - name: Package macOS App
        run: |
          cd build-macos/bin/${{ github.event.inputs.build_type }}
          zip -r ../../../JinGo-macOS-${{ github.event.inputs.brand_id }}.zip JinGo.app

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: JinGo-macOS-Brand${{ github.event.inputs.brand_id }}
          path: JinGo-macOS-${{ github.event.inputs.brand_id }}.zip

  # ============================================================================
  # Windows Build
  # ============================================================================
  build-windows:
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'windows' }}
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt
        id: install-qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: "windows"
          target: "desktop"
          arch: "win64_mingw"
          tools: "tools_mingw1310"
          cache: true

      - name: Debug Qt Environment
        run: |
          echo "Qt6_DIR: $env:Qt6_DIR"
          echo "QT_ROOT_DIR: $env:QT_ROOT_DIR"
          Get-ChildItem Env: | Where-Object { $_.Name -like "*Qt*" -or $_.Name -like "*QT*" }

      - name: Apply White Label Config
        shell: bash
        run: |
          cp white-labeling/${{ github.event.inputs.brand_id }}/bundle_config.json resources/bundle_config.json
          if [ -d "white-labeling/${{ github.event.inputs.brand_id }}/icons" ]; then
            cp -r white-labeling/${{ github.event.inputs.brand_id }}/icons/* resources/icons/ 2>/dev/null || true
          fi

      - name: Build Windows
        shell: pwsh
        run: |
          # 添加 Qt 和 MinGW 到 PATH
          $env:PATH = "$env:Qt6_DIR\bin;$env:IQTA_TOOLS\mingw1310_64\bin;$env:PATH"
          # 设置 MinGW 目录供脚本使用
          $env:MINGW_DIR = "$env:IQTA_TOOLS\mingw1310_64"
          if ("${{ github.event.inputs.build_type }}" -eq "Release") {
            .\scripts\build\build-windows.ps1
          } else {
            .\scripts\build\build-windows.ps1 -DebugBuild
          }

      - name: Package Windows
        shell: bash
        run: |
          cd build-windows/bin
          7z a ../../JinGo-Windows-${{ github.event.inputs.brand_id }}.zip *

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: JinGo-Windows-Brand${{ github.event.inputs.brand_id }}
          path: JinGo-Windows-${{ github.event.inputs.brand_id }}.zip

  # ============================================================================
  # Linux Build
  # ============================================================================
  build-linux:
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'linux' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build \
            libgl1-mesa-dev libxcb1-dev libxcb-cursor-dev libxcb-icccm4-dev \
            libxcb-image0-dev libxcb-keysyms1-dev libxcb-randr0-dev \
            libxcb-render-util0-dev libxcb-shape0-dev libxcb-sync-dev \
            libxcb-xfixes0-dev libxcb-xinerama0-dev libxcb-xkb-dev \
            libxkbcommon-dev libxkbcommon-x11-dev

      - name: Install Qt
        id: install-qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: "linux"
          target: "desktop"
          arch: "gcc_64"
          cache: true

      - name: Debug Qt Environment
        run: |
          echo "Qt6_DIR: $Qt6_DIR"
          echo "QT_ROOT_DIR: $QT_ROOT_DIR"
          env | grep -E "Qt|QT" || true

      - name: Apply White Label Config
        run: |
          cp white-labeling/${{ github.event.inputs.brand_id }}/bundle_config.json resources/bundle_config.json
          if [ -d "white-labeling/${{ github.event.inputs.brand_id }}/icons" ]; then
            cp -r white-labeling/${{ github.event.inputs.brand_id }}/icons/* resources/icons/ 2>/dev/null || true
          fi

      - name: Build Linux
        run: |
          chmod +x scripts/build/build-linux.sh
          # 脚本会自动使用 Qt6_DIR 环境变量
          if [ "${{ github.event.inputs.build_type }}" = "Release" ]; then
            ./scripts/build/build-linux.sh --release
          else
            ./scripts/build/build-linux.sh
          fi

      - name: Package Linux
        run: |
          cd build-linux/bin
          tar -czvf ../../JinGo-Linux-${{ github.event.inputs.brand_id }}.tar.gz *

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: JinGo-Linux-Brand${{ github.event.inputs.brand_id }}
          path: JinGo-Linux-${{ github.event.inputs.brand_id }}.tar.gz

  # ============================================================================
  # Android Build
  # ============================================================================
  build-android:
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'android' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;${{ env.ANDROID_NDK_VERSION }}"
          sdkmanager --install "build-tools;${{ env.ANDROID_BUILD_TOOLS_VERSION }}"
          sdkmanager --install "platforms;${{ env.ANDROID_PLATFORM }}"

      - name: Install Qt for Android
        id: install-qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: "linux"
          target: "android"
          arch: "android_arm64_v8a"
          cache: true

      - name: Debug Qt Environment
        run: |
          echo "Qt6_DIR: $Qt6_DIR"
          echo "QT_ROOT_DIR: $QT_ROOT_DIR"
          env | grep -E "Qt|QT" || true

      - name: Apply White Label Config
        run: |
          cp white-labeling/${{ github.event.inputs.brand_id }}/bundle_config.json resources/bundle_config.json
          if [ -d "white-labeling/${{ github.event.inputs.brand_id }}/icons/android" ]; then
            cp -r white-labeling/${{ github.event.inputs.brand_id }}/icons/android/* platform/android/app/src/main/res/ 2>/dev/null || true
          fi

      - name: Build Android
        run: |
          chmod +x scripts/build/build-android.sh
          # 设置环境变量供脚本使用
          export ANDROID_SDK_ROOT="$ANDROID_HOME"
          export ANDROID_NDK_VERSION="${{ env.ANDROID_NDK_VERSION }}"
          # Qt6_DIR 由 install-qt-action 自动设置
          if [ "${{ github.event.inputs.build_type }}" = "Release" ]; then
            ./scripts/build/build-android.sh --release --abi arm64-v8a
          else
            ./scripts/build/build-android.sh --abi arm64-v8a
          fi

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: JinGo-Android-Brand${{ github.event.inputs.brand_id }}
          path: build-android/android-build/build/outputs/apk/**/*.apk

  # ============================================================================
  # iOS Build
  # ============================================================================
  build-ios:
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'ios' }}
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt for iOS
        id: install-qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: "mac"
          target: "ios"
          cache: true

      - name: Debug Qt Environment
        run: |
          echo "Qt6_DIR: $Qt6_DIR"
          echo "QT_ROOT_DIR: $QT_ROOT_DIR"
          env | grep -E "Qt|QT" || true

      - name: Apply White Label Config
        run: |
          cp white-labeling/${{ github.event.inputs.brand_id }}/bundle_config.json resources/bundle_config.json
          if [ -d "white-labeling/${{ github.event.inputs.brand_id }}/icons/ios" ]; then
            cp -r white-labeling/${{ github.event.inputs.brand_id }}/icons/ios/* platform/ios/Assets.xcassets/AppIcon.appiconset/ 2>/dev/null || true
          fi

      - name: Build iOS (Xcode Project)
        run: |
          chmod +x scripts/build/build-ios.sh
          # 脚本会自动使用 Qt6_DIR 环境变量
          ./scripts/build/build-ios.sh --xcode

      - name: Build with Xcode (Device - Unsigned)
        run: |
          cd build-ios
          xcodebuild -project JinGo.xcodeproj \
            -scheme JinGo \
            -configuration ${{ github.event.inputs.build_type }} \
            -destination 'generic/platform=iOS' \
            -archivePath JinGo.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            archive

      - name: Export Unsigned IPA
        run: |
          cd build-ios
          mkdir -p Payload
          cp -r JinGo.xcarchive/Products/Applications/JinGo.app Payload/
          zip -r ../JinGo-iOS-${{ github.event.inputs.brand_id }}-unsigned.ipa Payload

      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: JinGo-iOS-Brand${{ github.event.inputs.brand_id }}
          path: JinGo-iOS-${{ github.event.inputs.brand_id }}-unsigned.ipa

  # ============================================================================
  # Create Release (optional)
  # ============================================================================
  create-release:
    needs: [build-macos, build-windows, build-linux, build-android, build-ios]
    if: always() && github.event.inputs.build_type == 'Release'
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List Artifacts
        run: |
          echo "=== Downloaded Artifacts ==="
          find artifacts -type f -name "*.*"
